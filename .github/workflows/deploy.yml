name: Infra Deployment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      IMAGE_TAG: ${{ github.sha }}
      IMAGE_URI: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}
      ECS_CLUSTER_NAME: ki-url-cluster   
      ECS_SERVICE_NAME: ki-url-service   
      CODEDEPLOY_APP_NAME: ki-ecs
      CODEDEPLOY_DEPLOYMENT_GROUP: ki-ecs-group

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-user
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: infra
        run: terraform init -backend-config="bucket=ki-terraform-state" -backend-config="region=$AWS_REGION"

      - name: Terraform Plan
        working-directory: infra
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve tfplan
      
      - name: Create AppSpec file
        run: |
          echo '{
            "version": "0.0",
            "Resources": [
              {
                "TargetService": {
                  "Type": "AWS::ECS::Service",
                  "Properties": {
                    "TaskDefinition": "$IMAGE_URI",
                    "LoadBalancerInfo": {
                      "ContainerName": "url-shortener",
                      "ContainerPort": 8080
                    }
                  }
                }
              }
            ]
          }
          EOF   

      - name: Trigger CodeDeploy ECS Deployment
        run: aws deploy create-deployment \
             --application-name "$CODEDEPLOY_APP_NAME" \
             --deployment-group-name "$CODEDEPLOY_DEPLOYMENT_GROUP" \
             --deployment-config-name CodeDeployDefault.ECSCanary10Percent5Minutes \
             --description "Deployment triggered by GitHub Actions" \
             --revision revisionType=AppSpecContent,appSpecContent=file://appspec.json

      - name: Wait for Deployment Completion
        run: aws deploy wait deployment-successful \
             --deployment-id $(aws deploy list-deployments \
             --application-name "$CODEDEPLOY_APP_NAME" \
             --deployment-group-name "$CODEDEPLOY_DEPLOYMENT_GROUP" \
             --include-only-statuses Created,Queued,InProgress \
             --query "deployments[-1]" --output text)
